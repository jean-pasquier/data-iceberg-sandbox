volumes:
  prometheus:
  grafana:


services:

  ### Prometheus ###

  prometheus:
    image: "prom/prometheus:latest"
    restart: always
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--web.console.libraries=/usr/share/prometheus/console_libraries"
      - "--web.console.templates=/usr/share/prometheus/consoles"
      - "--web.listen-address=0.0.0.0:9500"
      - "--storage.tsdb.retention.time=7d"
    volumes:
      - "prometheus:/prometheus"
      - "./prometheus.yaml:/etc/prometheus/prometheus.yml"
    ports:
      - "9500:9500"
    healthcheck:
      test:
        - CMD-SHELL
        - sh -c 'printf "GET /-/healthy HTTP/1.0\n\n" | nc localhost 9500; exit $$?;'
      interval: 1s
      timeout: 5s
      retries: 5


  ### Grafana ###

  grafana:
    image: "grafana/grafana-oss:latest"
    restart: always
    command: []
    ports:
      - "3001:3000"
    volumes:
      - "grafana:/var/lib/grafana"
      - "./grafana/grafana.ini:/etc/grafana/grafana.ini"
      - "./grafana/grafana-datasource.yml:/etc/grafana/provisioning/datasources/grafana-datasource.yml"
      - "./grafana/grafana-dashboard.yml:/etc/grafana/provisioning/dashboards/grafana-dashboard.yml"
      - "./grafana/dashboards/:/dashboards"
    healthcheck:
      test:
        - CMD-SHELL
        - bash -c 'printf "GET / HTTP/1.1\n\n" > /dev/tcp/127.0.0.1/3000; exit $$?;'
      interval: 1s
      timeout: 5s
      retries: 5
